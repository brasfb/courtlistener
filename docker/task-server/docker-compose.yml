version: "3.7"
volumes:
  cl-judge-pics:
networks:
  cl_net_overlay:
    driver: overlay
    external: true
services:
  celery_prefork:
    environment:
      CELERY_CONCURRENCY: ${CELERY_PREFORK_CONCURRENCY:?CELERY_PREFORK_CONCURRENCY not defined}
      CELERY_QUEUES: celery
      CELERY_PREFETCH_MULTIPLIER: 1
    image: freelawproject/courtlistener:latest-celery
    depends_on:
      - cl-doctor
      - cl-disclosures
      - cl-judge-pics
    deploy:
      resources:
        limits:
          cpus: "${CELERY_PREFORK_CONCURRENCY}"
          memory: "${CELERY_PREFORK_MEMORY:-1}GB"
      restart_policy:
        condition: on-failure
    volumes:
      - "${POSTGRESQL_SOCK:-/dev/null}:/var/run/postgresql"
      - "${DJANGO_MEDIA_ROOT:-/sata}:/storage"
      - cl-judge-pics:${PYTHON_PACKAGES}/judge_pics
    logging:
      driver: journald
    networks:
      - cl_net_overlay

  celery_prefork_bulk:
    environment:
      CELERY_CONCURRENCY: ${CELERY_PREFORK_BULK_CONCURRENCY:?CELERY_PREFORK_BULK_CONCURRENCY not defined}
      CELERY_QUEUES: batch1,batch2
      CELERY_PREFETCH_MULTIPLIER: 5
    image: freelawproject/courtlistener:latest-celery
    depends_on:
      - cl-judge-pics
      - cl-doctor
      - cl-disclosures
    deploy:
      resources:
        limits:
          cpus: "${CELERY_PREFORK_BULK_CONCURRENCY}"
          memory: "${CELERY_PREFORK_BULK_MEMORY:-1}GB"
      restart_policy:
        condition: on-failure
    volumes:
      - "${POSTGRESQL_SOCK:-/dev/null}:/var/run/postgresql"
      - "${DJANGO_MEDIA_ROOT:-/sata}:/storage"
      - cl-judge-pics:${PYTHON_PACKAGES}/judge_pics
    logging:
      driver: journald
    networks:
      - cl_net_overlay

  cl-judge-pics:
    image: freelawproject/judge-pics:latest
    container_name: "cl-judge-pics"
    deploy:
      restart_policy:
        condition: none
    volumes:
      - cl-judge-pics:${PYTHON_PACKAGES}/judge_pics

  cl-doctor:
    image: freelawproject/doctor:latest
    container_name: "cl-doctor"
    networks:
      - cl_net_overlay
    logging:
      driver: journald

  cl-disclosures:
    image: freelawproject/disclosure-extractor:latest
    container_name: "cl-disclosures"
    networks:
      - cl_net_overlay
    logging:
      driver: journald
